---
title: 'Rust Agent + DAGï¼šä¸ºä»€ä¹ˆçœŸæ­£å¤æ‚çš„ä»»åŠ¡ï¼Œå¿…é¡»ç”¨â€œä»»åŠ¡å›¾â€'
date: '2026-01-07'
description: 'æ·±å…¥è®²è§£å¦‚ä½•ç”¨ Rust æ„å»ºä¸€ä¸ªæ”¯æŒå¤æ‚ä»»åŠ¡è°ƒåº¦çš„ AI Agentï¼Œé‡ç‚¹ä»‹ç»ä»»åŠ¡å›¾ï¼ˆDAGï¼‰æ¨¡å‹çš„è®¾è®¡ä¸å®ç°ã€‚'
tags: ['Rust', 'AI Agent']
---

å¦‚æœä½ å·²ç»å®ç°äº†å‰é¢å‡ ç¯‡é‡Œçš„ Agentï¼š

* æœ‰ Executor
* æœ‰å¹¶å‘
* æœ‰é•¿æœŸè®°å¿†

ä½ å¾ˆå¿«ä¼šæ’ä¸Šä¸€å µ**ç»“æ„æ€§çš„å¢™**ã€‚

---

## ä¸€ä¸ªå¿…ç„¶ä¼šå‡ºç°çš„é—®é¢˜ï¼šPlan â†’ Act å¾ªç¯å¼€å§‹å¤±æ§

å…ˆçœ‹ä¸€ä¸ªçœŸå®ä½†å¸¸è§çš„ Agent è¡Œä¸ºï¼š

> â€œæˆ‘å…ˆæŸ¥ Aï¼Œå†æŸ¥ Bï¼Œå¦‚æœ B å¤±è´¥å°±é‡è¯• Aï¼Œç„¶åæ ¹æ® A+B å†³å®šæ˜¯å¦æŸ¥ Cï¼Œ
> å¦‚æœ C æˆåŠŸå°±æ±‡æ€»ï¼Œå¦åˆ™å›åˆ° B æ¢å‚æ•°å†è¯•ä¸€æ¬¡ã€‚â€

ç”¨ **while loop + if else** å†™å‡ºæ¥ä¼šå˜æˆä»€ä¹ˆï¼Ÿ

* çŠ¶æ€æ•£è½åœ¨å„å¤„
* å¾ˆéš¾åˆ¤æ–­â€œç°åœ¨åœ¨ç¬¬å‡ æ­¥â€
* Debug åŸºæœ¬é çŒœ
* æƒ³å¹¶å‘ï¼Ÿå‡ ä¹ä¸å¯èƒ½

**æ ¹å› æ˜¯ï¼šä½ åœ¨ç”¨â€œçº¿æ€§æ¨¡å‹â€ï¼Œè§£å†³â€œå›¾ç»“æ„é—®é¢˜â€ã€‚**

---

## Agent çš„çœŸå®æ‰§è¡Œæ¨¡å‹ï¼Œå…¶å®æ˜¯ DAG

å‡ ä¹æ‰€æœ‰â€œç¨å¾®å¤æ‚â€çš„ Agent ä»»åŠ¡ï¼Œæœ¬è´¨éƒ½æ˜¯ï¼š

```text
      â”Œâ”€â”€ Task A â”€â”€â”
Goal â”€â”¤             â”œâ”€â”€ Task D â”€â”€ Final
      â””â”€â”€ Task B â”€â”€â”˜
            â”‚
         Task C
```

è¿™å°±æ˜¯ä¸€ä¸ª **DAGï¼ˆDirected Acyclic Graphï¼Œæœ‰å‘æ— ç¯å›¾ï¼‰**ã€‚

---

## ä¸ºä»€ä¹ˆ DAG å¯¹ Agent æ˜¯è´¨å˜

ä½ å¯ä»¥åœ¨æ–‡ç« é‡Œç›´æ¥ç‚¹åè¿™ 5 ä¸ªèƒ½åŠ›ï¼š

| èƒ½åŠ›   | Loop æ¨¡å‹ | DAG æ¨¡å‹ |
| ---- | ------- | ------ |
| å¹¶å‘   | å›°éš¾      | å¤©ç„¶æ”¯æŒ   |
| å¤±è´¥å¤„ç† | æ··ä¹±      | èŠ‚ç‚¹çº§    |
| é‡è¯•   | å…¨å±€      | å±€éƒ¨     |
| å¯è§£é‡Šæ€§ | å¾ˆå·®      | éå¸¸æ¸…æ™°   |
| æ‰©å±•æ€§  | å¿«é€Ÿè…åŒ–    | ç»“æ„ç¨³å®š   |

ä¸€å¥è¯æ€»ç»“ï¼š

> **Loop æ˜¯ Demoï¼ŒDAG æ‰æ˜¯ç³»ç»Ÿã€‚**

---

## ç”¨ Rust å»ºæ¨¡ Task Graphï¼ˆæ ¸å¿ƒæŠ½è±¡ï¼‰

### Step 1ï¼šå®šä¹‰ Task Node

```rust
pub struct TaskNode {
    pub id: TaskId,
    pub tool: String,
    pub input: Value,
    pub depends_on: Vec<TaskId>,
}
```

å…³é”®ç‚¹åªæœ‰ä¸€ä¸ªï¼š
ğŸ‘‰ **æ˜¾å¼ä¾èµ–å…³ç³»**

---

### Step 2ï¼šTask Graph æœ¬èº«

```rust
pub struct TaskGraph {
    pub nodes: HashMap<TaskId, TaskNode>,
}
```

ä½ ç°åœ¨å¯ä»¥æ¸…æ¥šå›ç­”ï¼š

* å“ªäº›ä»»åŠ¡å¯ä»¥å¹¶å‘ï¼Ÿ
* å“ªäº›ä»»åŠ¡å¿…é¡»ç­‰ï¼Ÿ

---

## Agent çš„æ–°èŒè´£ï¼šä¸å†â€œç›´æ¥è¡ŒåŠ¨â€ï¼Œè€Œæ˜¯â€œç”Ÿæˆä»»åŠ¡å›¾â€

è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„**æ€ç»´è½¬å˜**ï¼š

> LLM ä¸è´Ÿè´£â€œæ€ä¹ˆæ‰§è¡Œâ€
> LLM åªè´Ÿè´£â€œä»»åŠ¡ç»“æ„â€

### LLM è¾“å‡ºç¤ºä¾‹ï¼ˆJSONï¼‰

```json
{
  "type": "TaskGraph",
  "nodes": [
    {"id":"A","tool":"read_file","input":{"path":"log.txt"}},
    {"id":"B","tool":"http_get","input":{"url":"..."}},
    {"id":"C","tool":"analyze","depends_on":["A","B"]},
    {"id":"D","tool":"summarize","depends_on":["C"]}
  ]
}
```

---

## Executor å‡çº§ï¼šä»â€œæ‰§è¡Œä»»åŠ¡â€åˆ°â€œè°ƒåº¦ä»»åŠ¡å›¾â€

### æ ¸å¿ƒç®—æ³•ï¼šæ‹“æ‰‘æ‰§è¡Œï¼ˆTopological Executionï¼‰

```rust
while let Some(ready_tasks) = graph.ready_nodes() {
    run_in_parallel(ready_tasks).await;
    graph.mark_done(ready_tasks);
}
```

### ready_nodes çš„å®šä¹‰

```text
ä¸€ä¸ªèŠ‚ç‚¹ï¼š
- æ‰€æœ‰ depends_on éƒ½å·²å®Œæˆ
- è‡ªå·±è¿˜æ²¡æ‰§è¡Œ
```

---

## DAG + Tokioï¼šå¹¶å‘è°ƒåº¦çš„è‡ªç„¶ç»“åˆ

```rust
use futures::stream::FuturesUnordered;

let mut running = FuturesUnordered::new();

for task in ready_tasks {
    running.push(executor.run_task(task));
}

while let Some(result) = running.next().await {
    graph.record_result(result);
}
```

ğŸ“Œ Tokio åœ¨è¿™é‡Œä¸æ˜¯â€œåŠ é€Ÿå™¨â€ï¼Œè€Œæ˜¯**è°ƒåº¦å¼•æ“çš„ä¸€éƒ¨åˆ†**ã€‚

---

## å¤±è´¥ä¸æ˜¯å¼‚å¸¸ï¼Œè€Œæ˜¯å›¾çš„ä¸€éƒ¨åˆ†

è¿™æ˜¯ DAG æ¨¡å‹æœ€å¼ºçš„ä¸€ç‚¹ã€‚

### ä¸‰ç§å¤±è´¥ç­–ç•¥ï¼ˆéå¸¸é€‚åˆå†™æˆå°èŠ‚ï¼‰

#### â‘  Fail Fast

* ä»»ä¸€å…³é”®èŠ‚ç‚¹å¤±è´¥ â†’ æ•´ä½“å¤±è´¥

#### â‘¡ Retry Subgraph

* å¤±è´¥èŠ‚ç‚¹ + ä¸‹æ¸¸èŠ‚ç‚¹å…¨éƒ¨é‡è·‘

#### â‘¢ Fallback Branch

```text
Task B
  â”œâ”€ success â†’ Task C
  â””â”€ failure â†’ Task C'
```

è¿™äº›åœ¨ **loop æ¨¡å‹ä¸­å‡ ä¹æ— æ³•ä¼˜é›…å®ç°**ã€‚

---

## Debug ä½“éªŒçš„è´¨å˜ï¼šä»»åŠ¡å›¾ = æ‰§è¡Œè®°å½•

å½“ä½ æŠŠæ¯æ¬¡æ‰§è¡Œéƒ½è®°å½•æˆï¼š

```json
{
  "node":"C",
  "start":"...",
  "end":"...",
  "status":"failed",
  "error":"timeout"
}
```

ä½ ä¼šç¬¬ä¸€æ¬¡æ„Ÿè§‰åˆ°ï¼š

> â€œAgent æ˜¯ä¸€ä¸ª**å¯è§‚æµ‹ç³»ç»Ÿ**ï¼Œè€Œä¸æ˜¯é»‘ç›’ã€‚â€

---

## DAG + Memoryï¼šè®© Agent çœŸæ­£â€œå­¦ä¼šåšå¤æ‚äº‹â€

ç»“åˆä¸Šä¸€ç¯‡çš„ **Semantic Memory**ï¼Œä½ å¯ä»¥åšåˆ°ï¼š

* è®°ä½å“ªäº›å­å›¾ç»å¸¸å¤±è´¥
* è®°ä½æŸç±»ä»»åŠ¡çš„æœ€ä¼˜ç»“æ„
* ä¸‹æ¬¡è®© LLM **å¤ç”¨æˆç†Ÿ DAG æ¨¡æ¿**

è¿™ä¸€æ­¥ï¼Œå°±æ˜¯ä»ï¼š

> **Agent = æ¨ç†æœºå™¨**
> å‡çº§ä¸º
> **Agent = ç»éªŒé©±åŠ¨çš„æ‰§è¡Œç³»ç»Ÿ**

---

## åˆ°è¿™é‡Œï¼ŒAgent å·²ç»å˜æˆä»€ä¹ˆï¼Ÿ

å¦‚æœä½ æŠŠå‰å››ç¯‡èƒ½åŠ›å åŠ èµ·æ¥ï¼š

* å¹¶å‘ Executor
* æˆæœ¬æ§åˆ¶
* é•¿æœŸè®°å¿†
* DAG è°ƒåº¦

ä½ ç°åœ¨æ‹¥æœ‰çš„ï¼Œå…¶å®æ˜¯ä¸€ä¸ªï¼š

> **â€œLLM é©±åŠ¨çš„åˆ†å¸ƒå¼ä»»åŠ¡ç¼–æ’ç³»ç»Ÿï¼ˆå•æœºç‰ˆï¼‰â€**

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆï¼š

> å¤§å‚çœŸæ­£è½åœ°çš„ Agentï¼Œæœ€åéƒ½ä¼šé•¿å¾—åƒ Workflow / DAG / Schedulerã€‚