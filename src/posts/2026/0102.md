---
title: 'Rust + Tokioï¼šæŠŠ Agent ä» Demo å‡çº§ä¸ºâ€œç”Ÿäº§çº§æ‰§è¡Œå™¨â€'
date: '2026-01-02'
description: 'ä¸Šä¸€ç¯‡æˆ‘ä»¬ç”¨ Rust ä» 0 å†™äº†ä¸€ä¸ªå®Œæ•´ Agentï¼Œä½†å¦‚æœçœŸæŠŠå®ƒè·‘åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œå¾ˆå¿«å°±ä¼šé‡åˆ°å¹¶å‘ã€è¶…æ—¶ã€é‡å¤è°ƒç”¨ç­‰é—®é¢˜ã€‚è¿™ç¯‡æ–‡ç« å¸¦ä½ ç”¨ Tokio å†™ä¸€ä¸ªâ€œç”Ÿäº§çº§æ‰§è¡Œå™¨â€ï¼Œè§£å†³è¿™äº›ç—›ç‚¹ï¼Œè®©ä½ çš„ Agent çœŸæ­£èƒ½è·‘èµ·æ¥ã€‚'
tags: ['Rust', 'AI Agent']
---

åœ¨ä¸Šä¸€ç¯‡é‡Œï¼Œæˆ‘ä»¬ç”¨ Rust ä» 0 å†™äº†ä¸€ä¸ªå®Œæ•´ Agentï¼š
æœ‰ LLMã€æœ‰å·¥å…·ã€æœ‰è®°å¿†ã€æœ‰ Plan â†’ Act â†’ Observe å¾ªç¯ã€‚

ä½†å¦‚æœä½ çœŸæŠŠå®ƒè·‘åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œå¾ˆå¿«å°±ä¼šé‡åˆ°è¿™äº›é—®é¢˜ï¼š

* âŒ å·¥å…·è°ƒç”¨æ˜¯ä¸²è¡Œçš„ï¼Œæ˜æ˜å¯ä»¥å¹¶å‘å´åœ¨â€œæ’é˜Ÿç­‰â€
* âŒ ä¸€ä¸ªå·¥å…·å¡ä½ï¼Œæ•´ä¸ª Agent å°±å¡æ­»
* âŒ LLM ç–¯ç‹‚é‡å¤è°ƒç”¨åŒä¸€ä¸ªå·¥å…·ï¼Œtoken å’Œé’±ä¸€èµ·çƒ§
* âŒ å¤šä¸ª Agent åŒæ—¶è·‘ï¼ŒRPC / API è¢«æ‰“çˆ†
* âŒ æ²¡æœ‰â€œä»»åŠ¡çº§ç»“æ„â€ï¼ŒDebug åƒåœ¨ç ´æ¡ˆ

**æœ¬è´¨åŸå› åªæœ‰ä¸€ä¸ªï¼š**

> å¤§å¤šæ•° Agent å®ç°ï¼Œæ ¹æœ¬æ²¡æœ‰ä¸€ä¸ªâ€œåƒæ ·çš„æ‰§è¡Œå™¨ï¼ˆExecutorï¼‰â€ã€‚

è€Œ Rust + Tokioï¼Œæ°å¥½éå¸¸é€‚åˆå¹²è¿™ä»¶äº‹ã€‚

---

## ä»ã€Œå¾ªç¯ã€åˆ°ã€Œæ‰§è¡Œå™¨ã€ï¼šè®¤æ¸… Agent çš„çœŸå®å½¢æ€

æˆ‘ä»¬å…ˆé€€ä¸€æ­¥çœ‹ Agent åœ¨â€œå·¥ç¨‹ä¸Šâ€åˆ°åº•æ˜¯ä»€ä¹ˆã€‚

**ä¸æ˜¯**ä¸€ä¸ª while loop
**è€Œæ˜¯**ä¸€ä¸ªä¸æ–­ç”Ÿæˆå’Œæ‰§è¡Œã€Œä»»åŠ¡ï¼ˆTaskï¼‰ã€çš„ç³»ç»Ÿ

### æŠ½è±¡ä¸€ä¸‹ Agent çš„è¿è¡Œæ¨¡å‹

```text
User Goal
   â†“
Planner (LLM)
   â†“
ç”Ÿæˆä¸€ç»„ Actionsï¼ˆå¯èƒ½æœ‰ä¾èµ–ï¼‰
   â†“
Executor
   â†“
å¹¶å‘æ‰§è¡Œ Tools
   â†“
Collect Observations
   â†“
å†å–‚ç»™ Planner
```

âš ï¸ å…³é”®å˜åŒ–åœ¨è¿™é‡Œï¼š

> **ä¸€æ¬¡è§„åˆ’ï¼Œä¸ä¸€å®šåªäº§ç”Ÿä¸€ä¸ª Action**

æ¯”å¦‚ LLM å¯èƒ½è¯´ï¼š

> â€œå…ˆå¹¶è¡Œè¯·æ±‚ A / B / C ä¸‰ä¸ªæ¥å£ï¼Œç­‰ç»“æœå›æ¥å†ç»¼åˆåˆ†æâ€

å¦‚æœä½ è¿˜æ˜¯ç”¨â€œä¸€ä¸ª loop + ä¸€ä¸ª tool callâ€ï¼Œæ€§èƒ½å’Œæˆæœ¬éƒ½ä¼šå¾ˆå·®ã€‚

---

## å¼•å…¥æ ¸å¿ƒæ¦‚å¿µï¼šAction â‰  Task

åœ¨ä»£ç å±‚é¢ï¼Œæˆ‘ä»¬è¦æŠŠ **â€œLLM çš„æƒ³æ³•â€** å’Œ **â€œçœŸæ­£æ‰§è¡Œçš„ä»»åŠ¡â€** åˆ†å¼€ã€‚

### Actionï¼šLLM è§†è§’ï¼ˆé€»è¾‘å±‚ï¼‰

```rust
pub enum AgentAction {
    ToolCall { tool: String, input: Value },
    Parallel { actions: Vec<AgentAction> },
    Final { answer: String },
}
```

### Taskï¼šæ‰§è¡Œå™¨è§†è§’ï¼ˆç‰©ç†å±‚ï¼‰

```rust
pub struct Task {
    pub id: Uuid,
    pub tool: String,
    pub input: Value,
    pub timeout: Duration,
}
```

ğŸ‘‰ **LLM å†³å®šåšä»€ä¹ˆï¼ˆActionï¼‰**
ğŸ‘‰ **Executor å†³å®šæ€ä¹ˆã€ä½•æ—¶ã€å¹¶å‘å¤šå°‘å»åšï¼ˆTaskï¼‰**

è¿™æ˜¯ Agent å·¥ç¨‹åŒ–çš„åˆ†æ°´å²­ã€‚

---

## ç”¨ Tokio å†™ä¸€ä¸ª Agent Executor

### Executor çš„èŒè´£åªæœ‰ä¸‰ä»¶äº‹

1. æ§åˆ¶å¹¶å‘ï¼ˆä¸èƒ½æ— é™èµ·ä»»åŠ¡ï¼‰
2. æ§åˆ¶å¤±è´¥ï¼ˆè¶…æ—¶ / é‡è¯• / é™çº§ï¼‰
3. æ±‡æ€»ç»“æœï¼ˆObservationï¼‰

### Executor ç»“æ„

```rust
pub struct AgentExecutor {
    semaphore: Arc<Semaphore>,
    tool_registry: ToolRegistry,
}
```

### æ‰§è¡Œå•ä¸ª Taskï¼ˆå¸¦é™æµ + è¶…æ—¶ï¼‰

```rust
impl AgentExecutor {
    pub async fn run_task(&self, task: Task) -> TaskResult {
        let _permit = self.semaphore.acquire().await.unwrap();

        let tool = match self.tool_registry.get(&task.tool) {
            Some(t) => t,
            None => return TaskResult::error(task.id, "tool not found"),
        };

        let fut = tool.call(task.input);
        match tokio::time::timeout(task.timeout, fut).await {
            Ok(Ok(output)) => TaskResult::success(task.id, output),
            Ok(Err(e)) => TaskResult::error(task.id, e.to_string()),
            Err(_) => TaskResult::error(task.id, "timeout"),
        }
    }
}
```

ğŸ’¡ è¿™ä¸€å°æ®µä»£ç ï¼Œå·²ç»è§£å†³äº† 80% Agent åœ¨ç”Ÿäº§ä¸­çš„é—®é¢˜ã€‚

---

## å¹¶å‘æ‰§è¡Œï¼šParallel Action æ€ä¹ˆè½åœ°ï¼Ÿ

å½“ LLM ç»™å‡ºä¸€ä¸ªå¹¶è¡Œ Actionï¼š

```json
{
  "type": "Parallel",
  "actions": [
    {"type":"ToolCall","tool":"http_get","input":{"url":"..."}},
    {"type":"ToolCall","tool":"http_get","input":{"url":"..."}}
  ]
}
```

### è½¬æ¢ä¸º Tasks

```rust
fn actions_to_tasks(actions: Vec<AgentAction>) -> Vec<Task> {
    actions.into_iter().map(|a| {
        match a {
            AgentAction::ToolCall { tool, input } => Task {
                id: Uuid::new_v4(),
                tool,
                input,
                timeout: Duration::from_secs(10),
            },
            _ => unreachable!(),
        }
    }).collect()
}
```

### ç”¨ FuturesUnordered å¹¶å‘è·‘

```rust
use futures::stream::{FuturesUnordered, StreamExt};

pub async fn run_parallel(
    executor: Arc<AgentExecutor>,
    tasks: Vec<Task>,
) -> Vec<TaskResult> {
    let mut futs = FuturesUnordered::new();

    for task in tasks {
        let exec = executor.clone();
        futs.push(tokio::spawn(async move {
            exec.run_task(task).await
        }));
    }

    let mut results = vec![];
    while let Some(res) = futs.next().await {
        if let Ok(task_res) = res {
            results.push(task_res);
        }
    }
    results
}
```

ğŸ“Œ æ³¨æ„ï¼š

* **å¹¶å‘æ•°ç”± Semaphore æ§åˆ¶**
* ä¸ä¼šå› ä¸ºæŸä¸ª task å¡ä½è€Œé˜»å¡å…¨éƒ¨

---

## Observation æ±‡æ€»ï¼šå–‚ç»™ LLM çš„ä¸æ˜¯â€œåŸå§‹è¾“å‡ºâ€

å¾ˆå¤š Agent çš„ä¸€ä¸ªè‡´å‘½é—®é¢˜æ˜¯ï¼š

> ğŸ‘‰ æŠŠå·¥å…·çš„åŸå§‹ JSON å…¨é‡ä¸¢å›ç»™ LLM

è¿™æ ·ä¼šå¯¼è‡´ï¼š

* prompt å·¨å¤§
* token æˆæœ¬çˆ†ç‚¸
* LLM åè€ŒæŠ“ä¸ä½é‡ç‚¹

### æ­£ç¡®åšæ³•ï¼šObservation æ˜¯â€œæ‰§è¡Œå™¨åŠ å·¥åçš„ç»“æœâ€

```rust
pub struct Observation {
    pub summary: String,
    pub raw: Option<Value>,
}
```

ä½ å¯ä»¥åšï¼š

* æˆªæ–­
* ç»“æ„åŒ–
* é”™è¯¯å½’ç±»
* å¤šç»“æœåˆå¹¶

```rust
fn summarize_results(results: &[TaskResult]) -> Observation {
    let success = results.iter().filter(|r| r.is_ok()).count();
    let failed = results.len() - success;

    Observation {
        summary: format!(
            "Executed {} tasks: {} success, {} failed",
            results.len(), success, failed
        ),
        raw: None,
    }
}
```

ğŸ‘‰ **LLM è´Ÿè´£â€œæ€è€ƒâ€ï¼ŒExecutor è´Ÿè´£â€œè„æ´»ç´¯æ´»â€**

---

## é˜²æ­¢ Agent è·‘é£ï¼šç”Ÿäº§ç¯å¢ƒå¿…å¤‡çš„ 5 æ¡é“å¾‹

è¿™æ˜¯è¡€æ³ªæ€»ç»“ï¼Œç‰¹åˆ«é€‚åˆå†™åœ¨å…¬ä¼—å·é‡Œï¼š

### â‘  æœ€å¤§æ­¥æ•°ï¼ˆHard Stopï¼‰

```rust
if step > MAX_STEPS {
    return Final("Stopped: max steps reached");
}
```

### â‘¡ é‡å¤ Action æ£€æµ‹

* è¿ç»­ N æ¬¡è°ƒç”¨åŒä¸€ tool
* è¾“å…¥é«˜åº¦ç›¸ä¼¼
  â†’ å¼ºåˆ¶æ€»ç»“å¹¶ç»“æŸ

### â‘¢ Tool ç™½åå•

```rust
allowed_tools = ["http_get", "read_file"];
```

### â‘£ æˆæœ¬é¢„ç®—

* token ä¸Šé™
* tool è°ƒç”¨æ¬¡æ•°ä¸Šé™

### â‘¤ äººç±»å…œåº•ï¼ˆHuman-in-the-loopï¼‰

* é«˜é£é™© actionï¼ˆè½¬è´¦ / å†™æ–‡ä»¶ï¼‰
* å¿…é¡»äººå·¥ç¡®è®¤

---

## ä¸ºä»€ä¹ˆè¿™å¥— Agent æ›´â€œRust é£æ ¼â€ï¼Ÿ

å¦‚æœä½ ç”¨è¿‡ Python Agent æ¡†æ¶ï¼Œä¼šå¾ˆç†Ÿæ‚‰è¿™äº›ç—›ç‚¹ï¼š

| é—®é¢˜   | Python å¸¸è§æƒ…å†µ   | Rust æ–¹æ¡ˆ            |
| ---- | ------------- | ------------------ |
| å¹¶å‘   | async æ··ä¹±      | Tokio + Semaphore  |
| å†…å­˜   | éšè·‘éšæ¶¨          | æ˜ç¡®æ‰€æœ‰æƒ              |
| å¤±è´¥   | try/except åæ‰ | Result å¼ºåˆ¶å¤„ç†        |
| æ‰§è¡Œç»“æ„ | åŠ¨æ€ã€éšå¼         | æ˜ç¡® Task / Executor |
| é•¿æœŸè¿è¡Œ | å®¹æ˜“æ³„æ¼          | ç¨³å®š                 |

> **Agent ä¸€æ—¦â€œé•¿æœŸè·‘â€ï¼Œå°±å·²ç»æ˜¯ç³»ç»Ÿå·¥ç¨‹ï¼Œè€Œä¸æ˜¯ Prompt å·¥ç¨‹ã€‚**
